<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketplace - Vaulture</title>
    <meta
      name="description"
      content="Discover and purchase amazing digital content from creators worldwide"
    />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Styles -->
    <link rel="stylesheet" href="css/main.css" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîí</text></svg>"
    />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="index.html" class="logo">Vaulture</a>

        <nav class="nav">
          <a href="marketplace.html" class="nav-link active">Marketplace</a>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="profile.html" class="nav-link">Profile</a>
        </nav>

        <div class="nav-actions">
          <!-- Logged out state -->
          <div class="nav-actions-logged-out" id="navLoggedOut">
            <a href="login.html" class="btn btn-secondary">Log in</a>
            <a href="signup.html" class="btn btn-primary">Sign up</a>
          </div>

          <!-- Logged in state -->
          <div class="nav-actions-logged-in" id="navLoggedIn">
            <div
              class="user-avatar"
              onclick="window.location.href='profile.html'"
            >
              <div class="avatar-circle">
                <span id="navAvatarInitials">U</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main style="padding-top: var(--header-height)">
      <!-- Hero Section -->
      <section class="section-sm bg-light">
        <div class="container">
          <div class="text-center">
            <h1>Discover Digital Content</h1>
            <p>
              Browse thousands of digital products from talented creators
              worldwide
            </p>
          </div>
        </div>
      </section>

      <!-- Filters and Search -->
      <section class="marketplace-filters">
        <div class="container">
          <!-- Full Width Search Bar -->
          <div class="search-section">
            <div class="search-container-full">
              <input
                type="text"
                id="searchInput"
                class="form-input"
                placeholder="Search products, creators, or tags..."
              />
            </div>
          </div>

          <!-- Clean Dropdown Filters -->
          <div class="filters-section">
            <div class="filters-container-clean">
              <select id="categoryFilter" class="form-select filter-dropdown">
                <option value="">All Categories</option>
                <option value="design">Design</option>
                <option value="software">Software</option>
                <option value="ebooks">E-books</option>
                <option value="audio">Audio</option>
                <option value="video">Video</option>
                <option value="photography">Photography</option>
                <option value="other">Other</option>
              </select>

              <select id="priceFilter" class="form-select filter-dropdown">
                <option value="">Any Price</option>
                <option value="0-10">$0 - $10</option>
                <option value="10-25">$10 - $25</option>
                <option value="25-50">$25 - $50</option>
                <option value="50-100">$50 - $100</option>
                <option value="100+">$100+</option>
              </select>

              <select id="sortFilter" class="form-select filter-dropdown">
                <option value="created_at:desc">Newest</option>
                <option value="created_at:asc">Oldest</option>
                <option value="price:asc">Price: Low to High</option>
                <option value="price:desc">Price: High to Low</option>
                <option value="title:asc">Name: A to Z</option>
                <option value="title:desc">Name: Z to A</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Products Section -->
      <section class="section">
        <div class="container">
          <!-- Loading State -->
          <div id="loadingState" class="text-center" style="display: none">
            <div
              class="loading"
              style="height: 100px; margin: var(--spacing-xl) 0"
            ></div>
            <p>Loading products...</p>
          </div>

          <!-- Products Grid -->
          <div id="productsGrid" class="grid grid-4">
            <!-- Products will be loaded here -->
          </div>

          <!-- Empty State -->
          <div id="emptyState" class="empty-state" style="display: none">
            <div class="empty-state-icon">üîç</div>
            <h3>No products found</h3>
            <p>We couldn't find any products matching your criteria.</p>
            <p>Try adjusting your search terms or filter options.</p>
            <button
              id="clearFiltersFromEmpty"
              class="btn btn-primary"
              onclick="marketplace.clearFilters()"
            >
              Clear All Filters
            </button>
          </div>

          <!-- Pagination -->
          <div
            id="pagination"
            class="text-center"
            style="margin-top: var(--spacing-xl)"
          ></div>
        </div>
      </section>
    </main>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h2 class="modal-title">Product Details</h2>
          <button class="modal-close" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body" id="productModalBody">
          <!-- Product details will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Notifications Container -->
    <div
      class="notifications-container"
      style="
        position: fixed;
        top: var(--spacing-md);
        right: var(--spacing-md);
        z-index: 1000;
      "
    ></div>

    <!-- Scripts -->
    <script src="js/main.js"></script>
    <script>
      class Marketplace {
        constructor() {
          this.currentPage = 1;
          this.pageSize = 12;
          this.filters = {};
          this.searchQuery = "";
          this.sortBy = "created_at";
          this.sortOrder = "desc";

          this.initializeElements();
          this.setupEventListeners();
          this.loadProducts();
        }

        initializeElements() {
          this.searchInput = document.getElementById("searchInput");
          this.categoryFilter = document.getElementById("categoryFilter");
          this.priceFilter = document.getElementById("priceFilter");
          this.sortFilter = document.getElementById("sortFilter");
          this.clearFiltersBtn = document.getElementById("clearFilters");
          this.productsGrid = document.getElementById("productsGrid");
          this.loadingState = document.getElementById("loadingState");
          this.emptyState = document.getElementById("emptyState");
          this.pagination = document.getElementById("pagination");
          this.productModal = new Modal("productModal");
        }

        setupEventListeners() {
          // Search input with debounce
          this.searchInput.addEventListener(
            "input",
            Utils.debounce(() => this.handleSearch(), 500)
          );

          // Filter changes
          this.categoryFilter.addEventListener("change", () =>
            this.handleFilterChange()
          );
          this.priceFilter.addEventListener("change", () =>
            this.handleFilterChange()
          );
          this.sortFilter.addEventListener("change", () =>
            this.handleSortChange()
          );

          // Clear filters
          this.clearFiltersBtn.addEventListener("click", () =>
            this.clearFilters()
          );
        }

        handleSearch() {
          this.searchQuery = this.searchInput.value.trim();
          this.currentPage = 1;
          this.loadProducts();
        }

        handleFilterChange() {
          this.filters = {};

          if (this.categoryFilter.value) {
            this.filters.category = this.categoryFilter.value;
          }

          if (this.priceFilter.value) {
            const [min, max] = this.priceFilter.value.split("-");
            if (min) this.filters.min_price = parseFloat(min);
            if (max && max !== "+") this.filters.max_price = parseFloat(max);
          }

          this.currentPage = 1;
          this.loadProducts();
        }

        handleSortChange() {
          const [sortBy, sortOrder] = this.sortFilter.value.split(":");
          this.sortBy = sortBy;
          this.sortOrder = sortOrder;
          this.currentPage = 1;
          this.loadProducts();
        }

        clearFilters() {
          this.searchInput.value = "";
          this.categoryFilter.value = "";
          this.priceFilter.value = "";
          this.sortFilter.value = "created_at:desc";

          this.searchQuery = "";
          this.filters = {};
          this.sortBy = "created_at";
          this.sortOrder = "desc";
          this.currentPage = 1;

          this.loadProducts();
        }

        async loadProducts() {
          this.showLoading();

          try {
            const params = {
              page: this.currentPage,
              page_size: this.pageSize,
              sort_by: this.sortBy,
              sort_order: this.sortOrder,
              ...this.filters,
            };

            if (this.searchQuery) {
              params.query = this.searchQuery;
            }

            const response = await api.getProducts(params);
            this.renderProducts(response);
            this.renderPagination(response);
          } catch (error) {
            console.error("Failed to load products:", error);
            Utils.showNotification(
              "Failed to load products. Please try again.",
              "error"
            );
            this.showEmptyState();
          } finally {
            this.hideLoading();
          }
        }

        showLoading() {
          this.loadingState.style.display = "block";
          this.productsGrid.style.display = "none";
          this.emptyState.style.display = "none";
          this.pagination.style.display = "none";
        }

        hideLoading() {
          this.loadingState.style.display = "none";
        }

        showEmptyState() {
          this.emptyState.style.display = "block";
          this.productsGrid.style.display = "none";
          this.pagination.style.display = "none";
        }

        renderProducts(response) {
          if (!response.products || response.products.length === 0) {
            this.showEmptyState();
            return;
          }

          this.productsGrid.style.display = "grid";
          this.emptyState.style.display = "none";

          // Filter out any sample/filler products and only show real products
          const realProducts = response.products.filter(
            (product) =>
              product.title &&
              product.price !== undefined &&
              product.creator_name &&
              !product.title.toLowerCase().includes("sample") &&
              !product.title.toLowerCase().includes("example") &&
              !product.title.toLowerCase().includes("test")
          );

          if (realProducts.length === 0) {
            this.showEmptyState();
            return;
          }

          this.productsGrid.innerHTML = realProducts
            .map(
              (product) => `
                    <div class="product-card" onclick="marketplace.showProductModal(${
                      product.id
                    })">
                        <div class="product-image" style="background-image: url('${
                          product.image_url || ""
                        }'); background-size: cover; background-position: center;">
                            ${
                              !product.image_url
                                ? `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: var(--font-size-xl);">${this.getFileTypeIcon(
                                    product.file_type
                                  )}</div>`
                                : ""
                            }
                        </div>
                        <div class="product-content">
                            <div class="product-title">${Utils.sanitizeHTML(
                              product.title
                            )}</div>
                            <div class="product-description">${Utils.sanitizeHTML(
                              product.description || "No description available"
                            )}</div>
                            <div class="product-meta">
                                <div class="product-price">${Utils.formatPrice(
                                  product.price
                                )}</div>
                                <div class="product-category">${
                                  product.category || "General"
                                }</div>
                            </div>
                            <div class="product-creator">by ${Utils.sanitizeHTML(
                              product.creator_name
                            )}</div>
                        </div>
                    </div>
                `
            )
            .join("");
        }

        renderPagination(response) {
          if (response.total_pages <= 1) {
            this.pagination.style.display = "none";
            return;
          }

          this.pagination.style.display = "block";

          let paginationHTML = '<div class="pagination">';

          // Previous button
          if (response.has_prev) {
            paginationHTML += `<button class="btn btn-secondary" onclick="marketplace.goToPage(${
              this.currentPage - 1
            })">Previous</button>`;
          }

          // Page numbers
          const startPage = Math.max(1, this.currentPage - 2);
          const endPage = Math.min(response.total_pages, this.currentPage + 2);

          if (startPage > 1) {
            paginationHTML += `<button class="btn btn-secondary" onclick="marketplace.goToPage(1)">1</button>`;
            if (startPage > 2) {
              paginationHTML +=
                '<span style="padding: 0 var(--spacing-xs); color: var(--text-muted);">...</span>';
            }
          }

          for (let i = startPage; i <= endPage; i++) {
            const isActive = i === this.currentPage;
            paginationHTML += `<button class="btn ${
              isActive ? "btn-primary" : "btn-secondary"
            }" onclick="marketplace.goToPage(${i})">${i}</button>`;
          }

          if (endPage < response.total_pages) {
            if (endPage < response.total_pages - 1) {
              paginationHTML +=
                '<span style="padding: 0 var(--spacing-xs); color: var(--text-muted);">...</span>';
            }
            paginationHTML += `<button class="btn btn-secondary" onclick="marketplace.goToPage(${response.total_pages})">${response.total_pages}</button>`;
          }

          // Next button
          if (response.has_next) {
            paginationHTML += `<button class="btn btn-secondary" onclick="marketplace.goToPage(${
              this.currentPage + 1
            })">Next</button>`;
          }

          paginationHTML += "</div>";
          this.pagination.innerHTML = paginationHTML;
        }

        goToPage(page) {
          this.currentPage = page;
          this.loadProducts();
          window.scrollTo({ top: 0, behavior: "smooth" });
        }

        async showProductModal(productId) {
          try {
            // For now, show a simple modal. In a full implementation,
            // you'd fetch detailed product data from the API
            const modalBody = document.getElementById("productModalBody");
            modalBody.innerHTML = `
                        <div class="text-center" style="padding: var(--spacing-xl);">
                            <div class="loading" style="height: 60px; margin-bottom: var(--spacing-md);"></div>
                            <p>Loading product details...</p>
                        </div>
                    `;

            this.productModal.open();

            // Simulate API call
            setTimeout(() => {
              modalBody.innerHTML = `
                            <div class="text-center">
                                <h3>Product Details</h3>
                                <p>Product ID: ${productId}</p>
                                <p>This would show detailed product information, including:</p>
                                <ul style="text-align: left; margin: var(--spacing-lg) 0;">
                                    <li>Full description</li>
                                    <li>File details and preview</li>
                                    <li>Creator information</li>
                                    <li>Reviews and ratings</li>
                                    <li>Purchase button</li>
                                </ul>
                                <div style="margin-top: var(--spacing-lg);">
                                    <button class="btn btn-primary" onclick="marketplace.purchaseProduct(${productId})">
                                        Purchase Product
                                    </button>
                                </div>
                            </div>
                        `;
            }, 1000);
          } catch (error) {
            console.error("Failed to load product details:", error);
            Utils.showNotification("Failed to load product details", "error");
          }
        }

        purchaseProduct(productId) {
          // Check if user is logged in
          const token = localStorage.getItem("authToken");
          if (!token) {
            Utils.showNotification(
              "Please log in to purchase products",
              "warning"
            );
            window.location.href =
              "login.html?redirect=" + encodeURIComponent(window.location.href);
            return;
          }

          Utils.showNotification("Redirecting to checkout...", "info");
          // Redirect to checkout page
          window.location.href = `checkout.html?product=${productId}`;
        }

        getFileTypeIcon(fileType) {
          if (!fileType) return "üìÑ";

          if (fileType.includes("image")) return "üñºÔ∏è";
          if (fileType.includes("video")) return "üé•";
          if (fileType.includes("audio")) return "üéµ";
          if (fileType.includes("pdf")) return "üìã";
          if (fileType.includes("zip") || fileType.includes("archive"))
            return "üì¶";
          if (fileType.includes("code") || fileType.includes("text"))
            return "üíª";

          return "üìÑ";
        }
      }

      // Initialize marketplace
      let marketplace;
      document.addEventListener("DOMContentLoaded", () => {
        marketplace = new Marketplace();
      });
    </script>
  </body>
</html>
