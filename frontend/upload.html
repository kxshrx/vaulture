<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Product - Vaulture</title>
    <meta
      name="description"
      content="Upload your digital content and start selling on Vaulture"
    />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Styles -->
    <link rel="stylesheet" href="css/main.css" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîí</text></svg>"
    />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="index.html" class="logo">Vaulture</a>

        <nav class="nav">
          <a href="marketplace.html" class="nav-link">Marketplace</a>
          <a href="dashboard.html" class="nav-link">Dashboard</a>
          <a href="profile.html" class="nav-link">Profile</a>
        </nav>

        <div class="nav-actions">
          <!-- Upload navigation state managed by JavaScript -->
          <div class="nav-actions-logged-out" id="navLoggedOut">
            <a href="login.html" class="btn btn-secondary">Log in</a>
            <a href="signup.html" class="btn btn-primary">Sign up</a>
          </div>

          <div class="nav-actions-logged-in" id="navLoggedIn">
            <div
              class="user-avatar"
              onclick="window.location.href='profile.html'"
            >
              <div class="avatar-circle">
                <span id="navAvatarInitials">U</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main style="padding-top: var(--header-height)">
      <!-- Header Section -->
      <section class="section-sm bg-light">
        <div class="container">
          <div class="text-center">
            <h1>Upload Your Digital Content</h1>
            <p>Share your creations with the world and start earning</p>
          </div>
        </div>
      </section>

      <!-- Upload Form -->
      <section class="section">
        <div class="container">
          <div style="max-width: 800px; margin: 0 auto">
            <form id="uploadForm" class="form">
              <!-- Product Information -->
              <div class="card" style="margin-bottom: var(--spacing-xl)">
                <div class="card-header">
                  <h3>Product Information</h3>
                </div>
                <div class="card-body">
                  <div class="form-group">
                    <label for="title" class="form-label">Product Title</label>
                    <input
                      type="text"
                      id="title"
                      name="title"
                      class="form-input"
                      placeholder="Enter a clear, descriptive title"
                      required
                      maxlength="200"
                    />
                    <div class="form-help">
                      This will be the main title shown to buyers
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="description" class="form-label"
                      >Description</label
                    >
                    <textarea
                      id="description"
                      name="description"
                      class="form-input form-textarea"
                      placeholder="Describe what buyers will get, how to use it, and any special features..."
                      rows="6"
                      maxlength="2000"
                    ></textarea>
                    <div class="form-help">
                      Provide detailed information to help buyers understand
                      your product
                    </div>
                  </div>

                  <div class="grid grid-2">
                    <div class="form-group">
                      <label for="price" class="form-label">Price</label>
                      <div style="position: relative">
                        <span
                          style="
                            position: absolute;
                            left: var(--spacing-md);
                            top: 50%;
                            transform: translateY(-50%);
                            color: var(--text-muted);
                          "
                          >$</span
                        >
                        <input
                          type="number"
                          id="price"
                          name="price"
                          class="form-input"
                          placeholder="0.00"
                          min="0.01"
                          max="10000"
                          step="0.01"
                          required
                          style="padding-left: var(--spacing-lg)"
                        />
                      </div>
                      <div class="form-help">
                        Set a fair price for your content
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="category" class="form-label">Category</label>
                      <select
                        id="category"
                        name="category"
                        class="form-input form-select"
                        required
                      >
                        <option value="">Select a category</option>
                        <option value="design">Design</option>
                        <option value="software">Software</option>
                        <option value="ebooks">E-books</option>
                        <option value="audio">Audio</option>
                        <option value="video">Video</option>
                        <option value="photography">Photography</option>
                        <option value="other">Other</option>
                      </select>
                      <div class="form-help">
                        Choose the best category for your product
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="tags" class="form-label">Tags (Optional)</label>
                    <input
                      type="text"
                      id="tags"
                      name="tags"
                      class="form-input"
                      placeholder="web design, template, responsive, modern"
                      maxlength="500"
                    />
                    <div class="form-help">
                      Add comma-separated tags to help buyers find your product
                    </div>
                  </div>
                </div>
              </div>

              <!-- File Upload -->
              <div class="card" style="margin-bottom: var(--spacing-xl)">
                <div class="card-header">
                  <h3>Upload Files</h3>
                </div>
                <div class="card-body">
                  <!-- Main Product File -->
                  <div class="form-group">
                    <label class="form-label">Product File</label>
                    <div id="fileUploadArea" class="file-upload">
                      <div class="file-upload-icon">üìÅ</div>
                      <div class="file-upload-text">
                        <strong>Click to upload</strong> or drag and drop your
                        file here
                      </div>
                      <div class="file-upload-subtext">
                        Any file type accepted ‚Ä¢ Max 100MB
                      </div>
                    </div>
                    <div
                      id="selectedFile"
                      style="display: none; margin-top: var(--spacing-md)"
                    >
                      <div
                        class="card"
                        style="
                          padding: var(--spacing-md);
                          background-color: var(--background-light);
                        "
                      >
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            gap: var(--spacing-md);
                          "
                        >
                          <div
                            id="fileIcon"
                            style="font-size: var(--font-size-xl)"
                          >
                            üìÑ
                          </div>
                          <div style="flex: 1">
                            <div id="fileName" style="font-weight: 500"></div>
                            <div
                              id="fileSize"
                              style="
                                font-size: var(--font-size-sm);
                                color: var(--text-muted);
                              "
                            ></div>
                          </div>
                          <button
                            type="button"
                            id="removeFile"
                            class="btn btn-secondary btn-sm"
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Product Image (Optional) -->
                  <div class="form-group">
                    <label class="form-label">Product Image (Optional)</label>
                    <div id="imageUploadArea" class="file-upload">
                      <div class="file-upload-icon">üñºÔ∏è</div>
                      <div class="file-upload-text">
                        <strong>Click to upload</strong> or drag and drop an
                        image
                      </div>
                      <div class="file-upload-subtext">
                        PNG, JPG, or GIF ‚Ä¢ Max 10MB
                      </div>
                    </div>
                    <div
                      id="selectedImage"
                      style="display: none; margin-top: var(--spacing-md)"
                    >
                      <div
                        class="card"
                        style="
                          padding: var(--spacing-md);
                          background-color: var(--background-light);
                        "
                      >
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            gap: var(--spacing-md);
                          "
                        >
                          <img
                            id="imagePreview"
                            style="
                              width: 60px;
                              height: 60px;
                              object-fit: cover;
                              border-radius: var(--radius-sm);
                            "
                          />
                          <div style="flex: 1">
                            <div id="imageName" style="font-weight: 500"></div>
                            <div
                              id="imageSize"
                              style="
                                font-size: var(--font-size-sm);
                                color: var(--text-muted);
                              "
                            ></div>
                          </div>
                          <button
                            type="button"
                            id="removeImage"
                            class="btn btn-secondary btn-sm"
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Upload Options -->
              <div class="card" style="margin-bottom: var(--spacing-xl)">
                <div class="card-header">
                  <h3>Upload Options</h3>
                </div>
                <div class="card-body">
                  <div class="form-group">
                    <label
                      style="
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-xs);
                      "
                    >
                      <input
                        type="checkbox"
                        id="isActive"
                        name="isActive"
                        checked
                      />
                      <span
                        >Make this product available for purchase
                        immediately</span
                      >
                    </label>
                    <div class="form-help">
                      You can change this later from your dashboard
                    </div>
                  </div>

                  <div class="form-group">
                    <label
                      style="
                        display: flex;
                        align-items: center;
                        gap: var(--spacing-xs);
                      "
                    >
                      <input
                        type="checkbox"
                        id="agreeTerms"
                        name="agreeTerms"
                        required
                      />
                      <span
                        >I confirm that I own the rights to this content and
                        agree to the
                        <a href="terms.html" target="_blank"
                          >Terms of Service</a
                        ></span
                      >
                    </label>
                  </div>
                </div>
              </div>

              <!-- Submit Button -->
              <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                  <svg
                    width="20"
                    height="20"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    style="margin-right: var(--spacing-xs)"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Upload Product
                </button>
                <div style="margin-top: var(--spacing-md)">
                  <a href="dashboard.html" class="text-secondary"
                    >Cancel and go back</a
                  >
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>
    </main>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-body text-center">
          <div id="uploadProgress">
            <div
              style="
                font-size: var(--font-size-2xl);
                margin-bottom: var(--spacing-md);
              "
            >
              ‚¨ÜÔ∏è
            </div>
            <h3>Uploading your product...</h3>
            <div style="margin: var(--spacing-lg) 0">
              <div
                style="
                  background-color: var(--background-light);
                  height: 20px;
                  border-radius: 10px;
                  overflow: hidden;
                "
              >
                <div
                  id="progressBar"
                  style="
                    height: 100%;
                    background-color: var(--accent-color);
                    width: 0%;
                    transition: width 0.3s ease;
                  "
                ></div>
              </div>
              <div
                id="progressText"
                style="
                  margin-top: var(--spacing-sm);
                  font-size: var(--font-size-sm);
                  color: var(--text-muted);
                "
              >
                0%
              </div>
            </div>
            <p>Please don't close this page while uploading</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Notifications Container -->
    <div
      class="notifications-container"
      style="
        position: fixed;
        top: var(--spacing-md);
        right: var(--spacing-md);
        z-index: 1000;
      "
    ></div>

    <!-- Scripts -->
    <script src="js/main.js"></script>
    <script>
      class ProductUpload {
        constructor() {
          this.selectedFile = null;
          this.selectedImage = null;

          this.initializeElements();
          this.setupEventListeners();
          this.checkCreatorAuth();
        }

        initializeElements() {
          this.form = document.getElementById("uploadForm");
          this.formHandler = new FormHandler(this.form);

          // File upload elements
          this.fileUploadArea = document.getElementById("fileUploadArea");
          this.selectedFileDiv = document.getElementById("selectedFile");
          this.removeFileBtn = document.getElementById("removeFile");

          // Image upload elements
          this.imageUploadArea = document.getElementById("imageUploadArea");
          this.selectedImageDiv = document.getElementById("selectedImage");
          this.removeImageBtn = document.getElementById("removeImage");

          // Progress modal
          this.progressModal = new Modal("progressModal");
          this.progressBar = document.getElementById("progressBar");
          this.progressText = document.getElementById("progressText");
        }

        setupEventListeners() {
          // Main file upload
          this.fileUpload = new FileUpload(this.fileUploadArea, {
            maxSize: 100 * 1024 * 1024, // 100MB
            multiple: false,
          });
          this.fileUpload.onFilesSelected = (files) =>
            this.handleFileSelected(files[0]);

          // Image upload
          this.imageUpload = new FileUpload(this.imageUploadArea, {
            maxSize: 10 * 1024 * 1024, // 10MB
            allowedTypes: ["image/jpeg", "image/jpg", "image/png", "image/gif"],
            multiple: false,
          });
          this.imageUpload.onFilesSelected = (files) =>
            this.handleImageSelected(files[0]);

          // Remove file buttons
          this.removeFileBtn.addEventListener("click", () => this.removeFile());
          this.removeImageBtn.addEventListener("click", () =>
            this.removeImage()
          );

          // Form submission
          this.form.addEventListener("submit", (e) => this.handleSubmit(e));

          // Real-time validation for price
          const priceInput = document.getElementById("price");
          priceInput.addEventListener("input", () => {
            const value = parseFloat(priceInput.value);
            if (value < 0.01) {
              this.formHandler.showFieldErrors(priceInput, [
                "Minimum price is $0.01",
              ]);
            } else if (value > 10000) {
              this.formHandler.showFieldErrors(priceInput, [
                "Maximum price is $10,000",
              ]);
            } else {
              this.formHandler.showFieldErrors(priceInput, []);
            }
          });
        }

        async checkCreatorAuth() {
          try {
            if (!checkAuth()) {
              return;
            }

            const user = await api.getProfile();
            if (!user.is_creator) {
              Utils.showNotification(
                "You need to be a creator to upload products",
                "error"
              );
              setTimeout(() => {
                window.location.href = "dashboard.html";
              }, 2000);
            }
          } catch (error) {
            console.error("Auth check failed:", error);
            window.location.href = "login.html";
          }
        }

        handleFileSelected(file) {
          this.selectedFile = file;
          this.displaySelectedFile(file);
        }

        handleImageSelected(file) {
          this.selectedImage = file;
          this.displaySelectedImage(file);
        }

        displaySelectedFile(file) {
          document.getElementById("fileName").textContent = file.name;
          document.getElementById("fileSize").textContent =
            Utils.formatFileSize(file.size);
          document.getElementById("fileIcon").textContent = this.getFileIcon(
            file.type
          );

          this.fileUploadArea.style.display = "none";
          this.selectedFileDiv.style.display = "block";
        }

        displaySelectedImage(file) {
          document.getElementById("imageName").textContent = file.name;
          document.getElementById("imageSize").textContent =
            Utils.formatFileSize(file.size);

          // Create preview
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById("imagePreview").src = e.target.result;
          };
          reader.readAsDataURL(file);

          this.imageUploadArea.style.display = "none";
          this.selectedImageDiv.style.display = "block";
        }

        removeFile() {
          this.selectedFile = null;
          this.fileUploadArea.style.display = "block";
          this.selectedFileDiv.style.display = "none";
        }

        removeImage() {
          this.selectedImage = null;
          this.imageUploadArea.style.display = "block";
          this.selectedImageDiv.style.display = "none";
        }

        getFileIcon(fileType) {
          if (!fileType) return "üìÑ";

          if (fileType.includes("image")) return "üñºÔ∏è";
          if (fileType.includes("video")) return "üé•";
          if (fileType.includes("audio")) return "üéµ";
          if (fileType.includes("pdf")) return "üìã";
          if (fileType.includes("zip") || fileType.includes("archive"))
            return "üì¶";
          if (fileType.includes("text") || fileType.includes("code"))
            return "üíª";

          return "üìÑ";
        }

        async handleSubmit(e) {
          e.preventDefault();

          if (!this.formHandler.validate()) {
            Utils.showNotification(
              "Please fix the form errors before submitting",
              "error"
            );
            return;
          }

          if (!this.selectedFile) {
            Utils.showNotification("Please select a file to upload", "error");
            return;
          }

          const formData = this.formHandler.getData();

          if (!formData.agreeTerms) {
            Utils.showNotification(
              "Please agree to the terms of service",
              "error"
            );
            return;
          }

          try {
            // Create FormData for file upload
            const uploadData = new FormData();
            uploadData.append("title", formData.title);
            uploadData.append("description", formData.description || "");
            uploadData.append("price", formData.price);
            uploadData.append("category", formData.category);
            uploadData.append("tags", formData.tags || "");
            uploadData.append("file", this.selectedFile);

            if (this.selectedImage) {
              uploadData.append("image", this.selectedImage);
            }

            // Show progress modal
            this.progressModal.open();
            this.updateProgress(0);

            // Simulate upload progress (in real implementation, you'd track actual progress)
            const progressInterval = setInterval(() => {
              const currentWidth = parseInt(this.progressBar.style.width) || 0;
              if (currentWidth < 90) {
                this.updateProgress(currentWidth + Math.random() * 10);
              }
            }, 500);

            // Upload the product
            const response = await api.uploadProduct(uploadData);

            // Complete progress
            clearInterval(progressInterval);
            this.updateProgress(100);

            setTimeout(() => {
              this.progressModal.close();
              Utils.showNotification(
                "Product uploaded successfully!",
                "success"
              );

              // Redirect to dashboard
              setTimeout(() => {
                window.location.href = "dashboard.html";
              }, 1000);
            }, 1000);
          } catch (error) {
            this.progressModal.close();
            Utils.showNotification(
              error.message || "Upload failed. Please try again.",
              "error"
            );
          }
        }

        updateProgress(percentage) {
          this.progressBar.style.width = `${percentage}%`;
          this.progressText.textContent = `${Math.round(percentage)}%`;
        }
      }

      // Initialize upload
      let productUpload;
      document.addEventListener("DOMContentLoaded", () => {
        productUpload = new ProductUpload();
      });
    </script>
  </body>
</html>
