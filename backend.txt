
# Backend Documentation for Frontend Engineers

## 1. High-Level Overview

This document provides a detailed explanation of the backend for the Creators Platform. The backend is built with **FastAPI** (a Python web framework) and uses a **PostgreSQL** database via **SQLAlchemy** for data persistence. It's designed to be a secure and scalable platform for creators to sell digital content and for buyers to purchase it.

### Key Technologies:

*   **FastAPI**: For building the RESTful API.
*   **SQLAlchemy**: For interacting with the database (Object-Relational Mapper).
*   **Pydantic**: For data validation and settings management.
*   **Stripe**: For processing payments.
*   **Supabase**: For secure file storage.
*   **JWT (JSON Web Tokens)**: For user authentication.

### Core Concepts:

*   **Users**: Can be either a "buyer" or a "creator".
    *   **Buyers** can browse and purchase products.
    *   **Creators** can upload, manage, and sell products. They also have all the capabilities of a buyer.
    *   A buyer can upgrade their account to a creator account.
*   **Products**: Digital goods uploaded by creators. There are no restrictions on file types.
*   **Purchases**: Transactions are handled via Stripe. When a purchase is successful, the buyer gets access to download the product.
*   **Secure Downloads**: Download links are temporary, signed URLs to prevent unauthorized sharing.

---

## 2. API Endpoints

The API is organized into several routers, each handling a specific part of the application's functionality. All API routes are prefixed with their respective tags.

### Base URL: `/`

*   `GET /`: Returns a welcome message for the API.
*   `GET /health`: A health check endpoint that returns `{"status": "healthy"}`.

---

### 2.1. Authentication (`/auth`)

Handles user registration, login, and account upgrades.

*   **`POST /auth/register/creator`**
    *   **Description**: Registers a new user as a **creator**.
    *   **Request Body**: `RegisterSchema` (`email`, `password`, `display_name`, `bio`, `website`, `social_links`).
    *   **Response**: `UserResponse` with user details.

*   **`POST /auth/register/buyer`**
    *   **Description**: Registers a new user as a **buyer**.
    *   **Request Body**: `RegisterSchema` (same as creator).
    *   **Response**: `UserResponse` with user details.

*   **`POST /auth/login`**
    *   **Description**: Authenticates a user (both creators and buyers) and returns a JWT access token.
    *   **Request Body**: `LoginSchema` (`email`, `password`).
    *   **Response**: `TokenSchema` (`access_token`, `token_type`).

*   **`POST /auth/upgrade-to-creator`**
    *   **Description**: Upgrades an existing buyer account to a creator account.
    *   **Authentication**: Requires a valid JWT for the buyer.
    *   **Response**: `UserResponse` with updated user details.

---

### 2.2. User Profile (`/profile`)

Manages user profiles. All endpoints here require authentication.

*   **`GET /profile/me`**
    *   **Description**: Retrieves the complete profile of the currently logged-in user, including private information and statistics.
    *   **Response**: `UserProfileResponse` (includes stats like total products, sales, revenue, etc.).

*   **`PUT /profile/me`**
    *   **Description**: Updates the profile of the currently logged-in user.
    *   **Request Body**: `UserProfileUpdate` (`display_name`, `bio`, `website`, `social_links`).
    *   **Response**: `UserProfileResponse` with the updated profile.

*   **`POST /profile/me/change-password`**
    *   **Description**: Changes the password for the current user.
    *   **Request Body**: `PasswordChangeRequest` (`current_password`, `new_password`, `confirm_password`).
    *   **Response**: A success message.

*   **`GET /profile/search/users`**
    *   **Description**: Searches for users by their display name or email. Returns public profiles only.
    *   **Query Parameters**: `query`, `user_type` ('creator' or 'buyer'), `limit`.
    *   **Response**: A list of `PublicProfileResponse`.

*   **`DELETE /profile/me`**
    *   **Description**: **Permanently deletes** the current user's account. This is a soft delete for products to maintain purchase history.
    *   **Response**: A success message.

---

### 2.3. Creator (`/creator`)

Endpoints for creators to manage their products and view their stats. All endpoints require the user to be a creator.

*   **`POST /creator/upload`**
    *   **Description**: Uploads a new digital product. This is a multipart form data request.
    *   **Form Data**: `title`, `description`, `price`, `category`, `tags`, `file` (the product file), `image` (optional cover image).
    *   **Response**: `ProductResponse` with details of the created product.

*   **`GET /creator/products`**
    *   **Description**: Lists all products uploaded by the current creator.
    *   **Response**: A list of `ProductResponse`.

*   **`GET /creator/stats`**
    *   **Description**: Retrieves detailed statistics for the creator (total sales, earnings, per-product breakdown).
    *   **Response**: Creator statistics object.

---

### 2.4. Products (Public Browsing)

Endpoints for browsing and searching for products. These are public and do not require authentication.

*   **`GET /products`**
    *   **Description**: A powerful search endpoint to find products with filtering, sorting, and pagination.
    *   **Query Parameters**: `query`, `category`, `min_price`, `max_price`, `creator_name`, `tags`, `page`, `page_size`, `sort_by`, `sort_order`.
    *   **Response**: `ProductSearchResponse` which includes a list of products and pagination details.

*   **`GET /products/categories`**
    *   **Description**: Gets a list of all available product categories along with the number of products in each.
    *   **Response**: A list of category stats.

*   **`GET /products/category/{category}`**
    *   **Description**: Retrieves products belonging to a specific category.
    *   **Path Parameter**: `category` (enum value from `ProductCategory`).
    *   **Query Parameters**: `page`, `page_size`.
    *   **Response**: `ProductSearchResponse`.

---

### 2.5. Purchase (`/purchase`)

Handles the product purchasing workflow using Stripe.

*   **`POST /purchase/{product_id}`**
    *   **Description**: Initiates a purchase by creating a Stripe Checkout session.
    *   **Authentication**: Requires a logged-in user.
    *   **Path Parameter**: `product_id`.
    *   **Request Body**: `PurchaseRequest` (`success_url`, `cancel_url`).
    *   **Response**: `CheckoutSessionResponse` (`checkout_url`, `session_id`, `expires_at`). The frontend should redirect the user to the `checkout_url`.

*   **`POST /purchase/webhook`**
    *   **Description**: A webhook endpoint for Stripe to send events (e.g., `checkout.session.completed`). This is handled by the backend to confirm purchases. **The frontend does not interact with this directly.**

*   **`GET /purchase/session/{session_id}`**
    *   **Description**: Retrieves purchase information using the Stripe session ID.
    *   **Authentication**: Requires the user who made the purchase.
    *   **Response**: `PurchaseResponse`.

*   **`GET /purchase/mypurchases`**
    *   **Description**: Gets a list of all **completed** purchases for the current user.
    *   **Authentication**: Requires a logged-in user.
    *   **Response**: A list of `PurchaseWithProduct`.

*   **`GET /purchase/mypurchases/all`**
    *   **Description**: Gets ALL of the current user's purchases, regardless of payment status (e.g., PENDING, FAILED). Useful for viewing complete purchase history.
    *   **Authentication**: Requires a logged-in user.
    *   **Response**: A list of `PurchaseWithProduct`.

*   **`GET /purchase/stats`**
    *   **Description**: Retrieves purchase statistics for the current user (total spent, number of purchases).
    *   **Authentication**: Requires a logged-in user.
    *   **Response**: `PurchaseStatsResponse`.

*   **`POST /purchase/verify/{session_id}`**
    *   **Description**: Manually verifies the payment status of a purchase by checking with Stripe directly. Useful for cases where the webhook might be delayed.
    *   **Authentication**: Requires the user who made the purchase.
    *   **Response**: `PurchaseResponse`.

---

### 2.6. Download (`/download`)

Provides secure access to purchased products.

*   **`GET /download/{product_id}`**
    *   **Description**: Generates a temporary, signed URL to download a product.
    *   **Authentication**: Requires the user to have either purchased the product or be the creator who owns it.
    *   **Path Parameter**: `product_id`.
    *   **Response**: An object containing the `download_url`, `expires_in` (in seconds), `product_title`, and `access_type`.

---

### 2.7. Platform (`/platform`)

Public endpoints for platform-wide statistics.

*   **`GET /platform/popular`**
    *   **Description**: Gets the most popular products based on the number of sales.
    *   **Query Parameter**: `limit` (default is 10).
    *   **Response**: A list of popular products.

*   **`GET /platform/recent`**
    *   **Description**: Gets the most recently added products.
    *   **Query Parameter**: `limit` (default is 10).
    *   **Response**: A list of recent products.

*   **`GET /platform/categories/stats`**
    *   **Description**: Gets statistics for each product category (e.g., number of products, total sales).
    *   **Response**: A list of category statistics.

---

## 3. Data Models and Schemas

The backend uses Pydantic schemas for request and response validation. Here's a brief overview of the main data structures.

*   **User**: `id`, `email`, `hashed_password`, `is_creator`, `display_name`, `bio`, `website`, `social_links`, `created_at`.
*   **Product**: `id`, `title`, `description`, `price`, `category`, `tags`, `creator_id`, `file_url`, `image_url`, `is_active`, `created_at`.
*   **Purchase**: `id`, `user_id`, `product_id`, `stripe_session_id`, `amount_paid`, `payment_status` (`PENDING`, `COMPLETED`, `FAILED`), `created_at`, `completed_at`.

The schemas (`schemas/`) generally mirror these models but are tailored for specific API operations (e.g., `ProductCreate`, `UserResponse`).

---

## 4. Frontend Integration Notes

*   **Authentication**: Store the JWT `access_token` securely (e.g., in an HttpOnly cookie or local storage) and include it in the `Authorization` header for protected endpoints as `Bearer <token>`.
*   **Error Handling**: The API returns standard HTTP status codes. `4xx` for client errors (e.g., bad request, unauthorized) and `5xx` for server errors. The response body for errors usually contains a `detail` field with an error message.
*   **Stripe Integration**: The frontend's role in payments is to:
    1.  Call the `/purchase/{product_id}` endpoint to get a Stripe Checkout URL.
    2.  Redirect the user to this URL.
    3.  Handle the `success_url` and `cancel_url` redirects from Stripe. The `success_url` page is a good place to verify the purchase status.
*   **File Uploads**: Use `multipart/form-data` for the `/creator/upload` endpoint.
*   **Environment Variables**: The frontend will need to know the base URL of the backend API. This should be configurable.

This document should provide a solid foundation for developing the frontend. If any questions or ambiguities arise, please reach out to the backend team.
