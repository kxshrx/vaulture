
# Backend Documentation for Frontend Engineers

## 1. High-Level Overview

This document provides a detailed explanation of the backend for the Creators Platform. The backend is built with **FastAPI** (a Python web framework) and uses a **PostgreSQL** database via **SQLAlchemy** for data persistence. It's designed to be a secure and scalable platform for creators to sell digital content and for buyers to purchase it.

### Key Technologies:

*   **FastAPI**: For building the RESTful API.
*   **SQLAlchemy**: For interacting with the database (Object-Relational Mapper).
*   **Pydantic**: For data validation and settings management.
*   **Stripe**: For processing payments.
*   **Supabase**: For secure file storage.
*   **JWT (JSON Web Tokens)**: For user authentication.

### Core Concepts:

*   **Users**: Can be either a "buyer" or a "creator".
    *   **Buyers** can browse and purchase products.
    *   **Creators** can upload, manage, and sell products. They also have all the capabilities of a buyer.
    *   A buyer can upgrade their account to a creator account.
*   **Products**: Digital goods uploaded by creators. There are no restrictions on file types.
*   **Purchases**: Transactions are handled via Stripe. When a purchase is successful, the buyer gets access to download the product.
*   **Secure Downloads**: Download links are temporary, signed URLs to prevent unauthorized sharing.

---

## 2. API Endpoints

The API is organized into several routers, each handling a specific part of the application's functionality. All API routes are prefixed with their respective tags.

### Base URL: `/`

*   `GET /`: Returns a welcome message for the API.
*   `GET /health`: A health check endpoint that returns `{"status": "healthy"}`.

---

### 2.1. Authentication (`/auth`)

Handles user registration, login, and account upgrades.

*   **`POST /auth/register/creator`**
    *   **Description**: Registers a new user as a **creator**.
    *   **Request Body**: `RegisterSchema`
        ```json
        {
          "email": "user@example.com",
          "password": "password123",
          "display_name": "CreatorName",
          "bio": "This is my bio.",
          "website": "https://example.com",
          "social_links": {
            "twitter": "https://twitter.com/username"
          }
        }
        ```
    *   **Response**: `UserResponse`
        ```json
        {
          "id": 1,
          "email": "user@example.com",
          "is_creator": true,
          "display_name": "CreatorName",
          "bio": "This is my bio.",
          "website": "https://example.com",
          "social_links": {
            "twitter": "https://twitter.com/username"
          },
          "created_at": "2025-08-02T12:00:00Z",
          "total_products": 0,
          "total_sales": 0,
          "total_revenue": 0.0,
          "total_purchases": 0,
          "member_since": "2025-08-02T12:00:00Z"
        }
        ```

*   **`POST /auth/register/buyer`**
    *   **Description**: Registers a new user as a **buyer**.
    *   **Request Body**: `RegisterSchema` (same as creator registration).
    *   **Response**: `UserResponse` (with `"is_creator": false`).

*   **`POST /auth/login`**
    *   **Description**: Authenticates a user and returns a JWT access token.
    *   **Request Body**: `LoginSchema`
        ```json
        {
          "email": "user@example.com",
          "password": "password123"
        }
        ```
    *   **Response**: `TokenSchema`
        ```json
        {
          "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
          "token_type": "bearer",
          "expires_in": 1800
        }
        ```

*   **`POST /auth/upgrade-to-creator`**
    *   **Description**: Upgrades an existing buyer account to a creator account.
    *   **Authentication**: Requires a valid JWT for the buyer.
    *   **Response**: `UserResponse` with updated user details (`"is_creator": true`).

---

### 2.2. User Profile (`/profile`)

Manages user profiles. All endpoints here require authentication.

*   **`GET /profile/me`**
    *   **Description**: Retrieves the complete profile of the currently logged-in user.
    *   **Response**: `UserProfileResponse`
        ```json
        {
          "id": 1,
          "email": "user@example.com",
          "is_creator": true,
          "display_name": "CreatorName",
          "bio": "This is my bio.",
          "website": "https://example.com",
          "social_links": {
            "twitter": "https://twitter.com/username"
          },
          "total_products": 5,
          "total_sales": 10,
          "total_revenue": 150.50,
          "total_purchases": 2,
          "member_since": "2025-08-02T12:00:00Z"
        }
        ```

*   **`PUT /profile/me`**
    *   **Description**: Updates the profile of the currently logged-in user.
    *   **Request Body**: `UserProfileUpdate`
        ```json
        {
          "display_name": "NewDisplayName",
          "bio": "Updated bio.",
          "website": "https://new-website.com",
          "social_links": {
            "linkedin": "https://linkedin.com/in/username"
          }
        }
        ```
    *   **Response**: `UserProfileResponse` with the updated profile.

*   **`POST /profile/me/change-password`**
    *   **Description**: Changes the password for the current user.
    *   **Request Body**: `PasswordChangeRequest`
        ```json
        {
          "current_password": "password123",
          "new_password": "newPassword456",
          "confirm_password": "newPassword456"
        }
        ```
    *   **Response**:
        ```json
        {
          "message": "Password updated successfully"
        }
        ```

*   **`GET /profile/search/users`**
    *   **Description**: Searches for users by display name or email.
    *   **Query Parameters**: `query`, `user_type` ('creator' or 'buyer'), `limit`.
    *   **Response**: A list of `PublicProfileResponse`.
        ```json
        [
          {
            "id": 2,
            "display_name": "AnotherCreator",
            "bio": "Bio of another creator.",
            "website": null,
            "social_links": {},
            "is_creator": true,
            "total_products": 3,
            "member_since": "2025-07-20T10:00:00Z"
          }
        ]
        ```

*   **`DELETE /profile/me`**
    *   **Description**: **Permanently deletes** the current user's account.
    *   **Response**:
        ```json
        {
          "message": "Account deleted successfully"
        }
        ```

---

### 2.3. Creator (`/creator`)

Endpoints for creators to manage their products. Requires creator privileges.

*   **`POST /creator/upload`**
    *   **Description**: Uploads a new digital product.
    *   **Request Body**: `multipart/form-data`
        *   `title`: "My Awesome Product"
        *   `description`: "A description of my product."
        *   `price`: 19.99
        *   `category`: "E_BOOKS"
        *   `tags`: "fastapi,python,ebook"
        *   `file`: (file data)
        *   `image`: (optional image file data)
    *   **Response**: `ProductResponse`
        ```json
        {
          "id": 1,
          "creator_id": 1,
          "creator_name": "CreatorName",
          "title": "My Awesome Product",
          "description": "A description of my product.",
          "price": 19.99,
          "category": "E_BOOKS",
          "tags": "fastapi,python,ebook",
          "file_url": "https://<supabase-url>/.../product.zip",
          "image_url": "https://<supabase-url>/.../cover.png",
          "file_size": 1048576,
          "file_type": "application/zip",
          "is_active": true,
          "created_at": "2025-08-02T14:30:00Z"
        }
        ```

*   **`GET /creator/products`**
    *   **Description**: Lists all products uploaded by the current creator.
    *   **Response**: A list of `ProductResponse`.

*   **`GET /creator/stats`**
    *   **Description**: Retrieves detailed statistics for the creator.
    *   **Response**:
        ```json
        {
          "total_products": 5,
          "total_sales": 10,
          "total_revenue": 150.50,
          "products": [
            {
              "product_id": 1,
              "title": "My Awesome Product",
              "sales": 5,
              "revenue": 99.95
            }
          ]
        }
        ```

---

### 2.4. Products (Public Browsing)

Endpoints for browsing and searching for products.

*   **`GET /products`**
    *   **Description**: Search for products with filtering, sorting, and pagination.
    *   **Query Parameters**: `query`, `category`, `min_price`, `max_price`, `creator_name`, `tags`, `page`, `page_size`, `sort_by`, `sort_order`.
    *   **Response**: `ProductSearchResponse`
        ```json
        {
          "products": [
            {
              "id": 1,
              "creator_name": "CreatorName",
              "title": "My Awesome Product",
              "description": "A description...",
              "price": 19.99,
              "category": "E_BOOKS",
              "tags": "fastapi,python",
              "image_url": "https://...",
              "file_type": "application/zip",
              "created_at": "2025-08-02T14:30:00Z"
            }
          ],
          "total": 1,
          "page": 1,
          "page_size": 10,
          "total_pages": 1,
          "has_next": false,
          "has_prev": false
        }
        ```

*   **`GET /products/categories`**
    *   **Description**: Gets all available product categories with product counts.
    *   **Response**:
        ```json
        [
          {
            "category": "E_BOOKS",
            "product_count": 5
          },
          {
            "category": "VIDEO",
            "product_count": 2
          }
        ]
        ```

*   **`GET /products/category/{category}`**
    *   **Description**: Retrieves products filtered by a specific category.
    *   **Response**: `ProductSearchResponse`.

---

### 2.5. Purchase (`/purchase`)

Handles the product purchasing workflow.

*   **`POST /purchase/{product_id}`**
    *   **Description**: Creates a Stripe Checkout session for a product.
    *   **Request Body**: `PurchaseRequest`
        ```json
        {
          "success_url": "https://your-frontend.com/purchase/success",
          "cancel_url": "https://your-frontend.com/purchase/canceled"
        }
        ```
    *   **Response**: `CheckoutSessionResponse`
        ```json
        {
          "checkout_url": "https://checkout.stripe.com/...",
          "session_id": "cs_test_...",
          "expires_at": 1672531200
        }
        ```

*   **`POST /purchase/webhook`**
    *   **Description**: Webhook for Stripe to send events. **Not for frontend use.**

*   **`GET /purchase/session/{session_id}`**
    *   **Description**: Gets purchase information by Stripe session ID.
    *   **Response**: `PurchaseResponse`
        ```json
        {
          "id": 1,
          "user_id": 1,
          "product_id": 1,
          "stripe_payment_intent_id": "pi_...",
          "stripe_session_id": "cs_test_...",
          "amount_paid": 19.99,
          "currency": "usd",
          "payment_status": "completed",
          "created_at": "2025-08-02T18:00:00Z",
          "completed_at": "2025-08-02T18:01:00Z"
        }
        ```

*   **`GET /purchase/mypurchases`**
    *   **Description**: Gets a list of all **completed** purchases for the current user.
    *   **Response**: A list of `PurchaseWithProduct`.
        ```json
        [
          {
            "id": 1,
            "product_id": 1,
            "created_at": "2025-08-02T18:00:00Z",
            "completed_at": "2025-08-02T18:01:00Z",
            "amount_paid": 19.99,
            "payment_status": "completed",
            "product_title": "My Awesome Product",
            "product_description": "A description...",
            "product_price": 19.99,
            "product_category": "E_BOOKS",
            "product_file_type": "application/zip",
            "product_image_url": "https://..."
          }
        ]
        ```

*   **`GET /purchase/mypurchases/all`**
    *   **Description**: Gets ALL of the current user's purchases, regardless of payment status.
    *   **Response**: A list of `PurchaseWithProduct`.

*   **`GET /purchase/stats`**
    *   **Description**: Retrieves purchase statistics for the current user.
    *   **Response**: `PurchaseStatsResponse`
        ```json
        {
          "total_purchases": 5,
          "total_spent": 99.50,
          "categories": {
            "E_BOOKS": 3,
            "VIDEO": 2
          },
          "recent_purchases": 1
        }
        ```

*   **`POST /purchase/verify/{session_id}`**
    *   **Description**: Manually verifies and updates payment status.
    *   **Response**: `PurchaseResponse`.

---

### 2.6. Download (`/download`)

Provides secure access to purchased products.

*   **`GET /download/{product_id}`**
    *   **Description**: Generates a temporary, signed URL to download a product.
    *   **Response**:
        ```json
        {
          "download_url": "https://<supabase-url>/.../product.zip?token=...",
          "expires_in": 45,
          "product_title": "My Awesome Product",
          "access_type": "purchased"
        }
        ```

---

### 2.7. Platform (`/platform`)

Public endpoints for platform-wide statistics.

*   **`GET /platform/popular`**
    *   **Description**: Gets the most popular products by sales.
    *   **Response**: A list of `ProductListResponse`.

*   **`GET /platform/recent`**
    *   **Description**: Gets the most recently added products.
    *   **Response**: A list of `ProductListResponse`.

*   **`GET /platform/categories/stats`**
    *   **Description**: Gets statistics by product category.
    *   **Response**:
        ```json
        [
          {
            "category": "E_BOOKS",
            "total_products": 10,
            "total_sales": 50
          }
        ]
        ```

---

## 3. Data Models and Schemas

The backend uses Pydantic schemas for request and response validation. Here's a brief overview of the main data structures.

*   **User**: `id`, `email`, `hashed_password`, `is_creator`, `display_name`, `bio`, `website`, `social_links`, `created_at`.
*   **Product**: `id`, `title`, `description`, `price`, `category`, `tags`, `creator_id`, `file_url`, `image_url`, `is_active`, `created_at`.
*   **Purchase**: `id`, `user_id`, `product_id`, `stripe_session_id`, `amount_paid`, `payment_status` (`PENDING`, `COMPLETED`, `FAILED`), `created_at`, `completed_at`.

The schemas (`schemas/`) generally mirror these models but are tailored for specific API operations (e.g., `ProductCreate`, `UserResponse`).

---

## 4. Frontend Integration Notes

*   **Authentication**: Store the JWT `access_token` securely (e.g., in an HttpOnly cookie or local storage) and include it in the `Authorization` header for protected endpoints as `Bearer <token>`.
*   **Error Handling**: The API returns standard HTTP status codes. `4xx` for client errors (e.g., bad request, unauthorized) and `5xx` for server errors. The response body for errors usually contains a `detail` field with an error message.
*   **Stripe Integration**: The frontend's role in payments is to:
    1.  Call the `/purchase/{product_id}` endpoint to get a Stripe Checkout URL.
    2.  Redirect the user to this URL.
    3.  Handle the `success_url` and `cancel_url` redirects from Stripe. The `success_url` page is a good place to verify the purchase status.
*   **File Uploads**: Use `multipart/form-data` for the `/creator/upload` endpoint.
*   **Environment Variables**: The frontend will need to know the base URL of the backend API. This should be configurable.

This document should provide a solid foundation for developing the frontend. If any questions or ambiguities arise, please reach out to the backend team.
